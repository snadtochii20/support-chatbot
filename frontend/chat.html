<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ß–∞—Ç–±–æ—Ç</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />

  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="card shadow chat-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">–ß–∞—Ç–±–æ—Ç</h1>
        <div class="d-flex gap-2">
        
        </div>
      </div>

      <!-- –°—é–¥–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏—Å—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
      <div id="messages" class="card-body messages bg-light"></div>
      <div id="typing" style="font-style: italic; color: gray; display: none;">
  AI typing...
</div>


      <div class="card-footer">
        <div class="input-group">
          <input
            id="messageInput"
            type="text"
            class="form-control"
            placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
          />
          <button id="sendBtn" class="btn btn-primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

 <!-- Firebase (App + Firestore) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>


<script>
  // ===== Firebase –∫–æ–Ω—Ñ—ñ–≥ (–ü–Ü–î–°–¢–ê–í –°–í–û–á –î–ê–ù–Ü) =====
  const firebaseConfig = {
     apiKey: "AIzaSyAbOH_0LgvDcgyAY39FFGjDdGdLeGhL_Y0",
  authDomain: "support-chatbot-dea3d.firebaseapp.com",
  projectId: "support-chatbot-dea3d",
  storageBucket: "support-chatbot-dea3d.firebasestorage.app",
  messagingSenderId: "495512902836",
  appId: "1:495512902836:web:b270f82bbdf50d3e4e0be1",
  measurementId: "G-5C2PV3KM1G"
  };
  const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

 

  // ===== –î–æ–ø–æ–º—ñ–∂–Ω—ñ –∑–º—ñ–Ω–Ω—ñ =====
  const messagesDiv = document.getElementById("messages");
  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  // –∞–π–¥—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—è–∫—â–æ —î auth ‚Äî –±–µ—Ä–∏ –∑ localStorage)
  const userId = localStorage.getItem("userId") || "anonymous";

  // ===== –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —á–∞—Ç—É =====
  function addMessage(author, text, saveToDb = true) {
    const msg = document.createElement("div");
    msg.classList.add("mb-2");
    msg.innerHTML = `<strong>${author}:</strong> ${text}`;
    messagesDiv.appendChild(msg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
    if (saveToDb) {
      db.collection("messages").add({
        userId,
        author,
        text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }

  let typingEl = null;

  function showTyping() {
    if (typingEl) return;
    typingEl = document.createElement("div");
    typingEl.classList.add("fst-italic", "text-muted", "mt-1");
    typingEl.textContent = "AI –¥—Ä—É–∫—É—î...";
    messagesDiv.appendChild(typingEl);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function hideTyping() {
    if (!typingEl) return;
    typingEl.remove();
    typingEl = null;
  }

  // ===== –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è =====
  async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;

    // –ü–æ–∫–∞–∑—É—î–º–æ –Ω–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    addMessage("You", message);
    input.value = "";

    // –ü–æ–∫–∞–∑—É—î–º–æ "AI –¥—Ä—É–∫—É—î..."
    showTyping();

    try {
      const response = await fetch("http://localhost:3000/api/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message })
      });

      const data = await response.json();

      hideTyping();
      addMessage("AI", data.reply);
    } catch (err) {
      hideTyping();
      addMessage("AI", "–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ üò¢");
      console.error(err);
    }
  }

  // ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ =====
  async function loadHistory() {
    const snapshot = await db.collection("messages")
      .where("userId", "==", userId)
      .orderBy("createdAt")
      .get();

    snapshot.forEach(doc => {
      const m = doc.data();
      // saveToDb = false, —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ –≤ –±–∞–∑—ñ
      addMessage(m.author, m.text, false);
    });
  }

  // –ö–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ
  sendBtn.addEventListener("click", sendMessage);

  // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  // –°—Ç–∞—Ä—Ç: –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
  loadHistory();
</script>
<!-- –°—Ç–∞—Ä–∏–π —Å–∫—Ä–∏–ø—Ç WebSocket –±—ñ–ª—å—à–µ –ù–ï –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ -->
<!-- <script src="chat.js"></script> -->
</body>
</html>
